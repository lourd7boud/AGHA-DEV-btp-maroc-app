# ููุฎุต ุชูููุฐ ูุธุงู ุงููุฒุงููุฉ ุงูููุฑูุฉ (Realtime Sync)

## ๐ฏ ุงููุฏู

ุชู ุชูููุฐ ูุธุงู ูุฒุงููุฉ ููุฑู ูุนูู ุจููุณ ุทุฑููุฉ WhatsApp ู Google Docsุ ูุน ุฏุนู ูุงูู ููุถุน ุงูุฃูููุงูู.

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ุงูุฎุงุฏู (Backend)

#### ูููุงุช ุฌุฏูุฏุฉ:
- **`backend/src/realtime/socketServer.ts`** - ุฎุงุฏู Socket.IO ูููุฒุงููุฉ ุงูููุฑูุฉ
- **`backend/src/realtime/pgNotify.ts`** - ุฅุนุฏุงุฏ PostgreSQL LISTEN/NOTIFY
- **`backend/src/realtime/index.ts`** - ุชุตุฏูุฑ ูุญุฏุฉ ุงูู realtime

#### ูููุงุช ูุนุฏูุฉ:
- **`backend/src/index.ts`** - ุฅุถุงูุฉ ุชููุฆุฉ Socket.IO ู triggers
- **`backend/package.json`** - ุฅุถุงูุฉ socket.io dependency

#### ุงูููุฒุงุช:
- โ WebSocket server ูุน JWT authentication
- โ Room-based subscriptions (ุบุฑู ูููุณุชุฎุฏููู ูุงููุดุงุฑูุน)
- โ PostgreSQL LISTEN/NOTIFY triggers
- โ ุจุซ ููุฑู ููุนูููุงุช ูุฌููุน ุงูุฃุฌูุฒุฉ ุงููุชุตูุฉ

### 2. ุงูุนููู (Frontend)

#### ูููุงุช ุฌุฏูุฏุฉ:
- **`frontend-web/src/services/realtimeSync.ts`** - ุฎุฏูุฉ WebSocket client
- **`frontend-web/src/services/offlineSyncQueue.ts`** - ูุนุงูุฌ ุทุงุจูุฑ ุงูุฃูููุงูู
- **`frontend-web/src/hooks/useRealtimeSync.ts`** - React hook ูููุฒุงููุฉ ุงูููุฑูุฉ
- **`frontend-web/src/hooks/useProjectRealtime.ts`** - hook ููุงุดุชุฑุงู ูู ุชุญุฏูุซุงุช ุงููุดุฑูุน

#### ูููุงุช ูุนุฏูุฉ:
- **`frontend-web/src/hooks/useSyncManagerV3.ts`** - ุฏูุฌ ูุน ูุธุงู ุงูู realtime
- **`frontend-web/src/hooks/index.ts`** - ุชุตุฏูุฑ ุงูู hooks ุงูุฌุฏูุฏุฉ
- **`frontend-web/src/components/SyncIndicator.tsx`** - ุนุฑุถ ุญุงูุฉ ุงูู realtime
- **`frontend-web/package.json`** - ุฅุถุงูุฉ socket.io-client dependency

#### ุงูููุฒุงุช:
- โ ุงุชุตุงู WebSocket ุชููุงุฆู
- โ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆูุฉ ูุน exponential backoff
- โ Fallback ุฅูู polling ุนูุฏ ูุดู WebSocket
- โ ุชุญุฏูุซ ุชููุงุฆู ูู React components ุนุจุฑ Dexie useLiveQuery
- โ ูุธุงู ุฃุญุฏุงุซ ููุชูุงุตู ุจูู ุงูููููุงุช

### 3. ุงูุชูุซูู

- **`docs/REALTIME_SYNC.md`** - ุชูุซูู ุดุงูู ูููุธุงู ุจุงูุฅูุฌููุฒูุฉ

## ๐ง ููููุฉ ุงูุชุดุบูู

### 1. ุชุซุจูุช ุงูุชุจุนูุงุช

```bash
# Backend
cd backend
npm install socket.io

# Frontend
cd frontend-web
npm install socket.io-client
```

### 2. ุชุดุบูู ุงูุฎุงุฏู

```bash
cd backend
npm run dev
```

ุณูููู ุงูุฎุงุฏู ุชููุงุฆูุงู ุจู:
1. ุฅูุดุงุก ุฌุฏุงูู ops ู sync_clients
2. ุฅุนุฏุงุฏ triggers ูู NOTIFY
3. ุชุดุบูู Socket.IO server

### 3. ุชุดุบูู ุงูุนููู

```bash
cd frontend-web
npm run dev
```

## ๐ก ููููุฉ ุงูุนูู

```
User A ูุนุฏู โ ุงูุฎุงุฏู ูุทุจู โ PostgreSQL NOTIFY โ Socket.IO ูุจุซ โ User B ูุฑู ููุฑุงู
```

### ุงูุชูุงุตูู:

1. **User A ูููู ุจุชุนุฏูู**:
   - ุงูุชุบููุฑ ููุญูุธ ูู Dexie ูุญููุงู
   - ุงูุชุบููุฑ ููุฑุณู ููุฎุงุฏู ุนุจุฑ HTTP POST

2. **ุงูุฎุงุฏู ูุณุชูุจู**:
   - ูุทุจู ุงูุนูููุฉ ูู PostgreSQL
   - ูุณุฌู ูู ุฌุฏูู `ops`
   - Trigger ูุทูู `pg_notify`

3. **Socket.IO ูุณุชูุจู**:
   - ูุณูุน NOTIFY ูู PostgreSQL
   - ูุจุซ ูููุณุชุฎุฏููู ุงููุชุตููู

4. **User B ูุฑู ููุฑุงู**:
   - Socket ูุณุชูุจู ุงูุนูููุฉ
   - ูุทุจููุง ูู Dexie
   - useLiveQuery ูุญุฏุซ React ุชููุงุฆูุงู

## ๐ ุฃุญุฏุงุซ WebSocket

```typescript
// ุงูุงุชุตุงู
socket.emit('join:project', projectId);   // ุงุดุชุฑุงู ูู ูุดุฑูุน
socket.emit('leave:project', projectId);  // ุฅูุบุงุก ุงุดุชุฑุงู
socket.emit('sync:request', { since: serverSeq }); // ุทูุจ ุงูุนูููุงุช ุงููุงุฆุชุฉ

// ุงูุงุณุชูุจุงู
socket.on('sync:op', (operation) => {...});  // ุนูููุฉ ุฌุฏูุฏุฉ
socket.on('sync:state', (data) => {...});    // ุญุงูุฉ ุงููุฒุงููุฉ
```

## ๐ ุงูุฃูุงู

- JWT authentication ููู ุงุชุตุงู WebSocket
- ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู ูุจู ุงูุจุซ
- CORS ูุญุฏุฏ

## ๐ฑ ุฏุนู ุงูุฃูููุงูู

1. **ุนูุฏ ุงูุฃูููุงูู**:
   - ุงูุนูููุงุช ุชูุฎุฒู ูู `syncOperations` ูุน `synced: false`
   - ุงูุชุบููุฑุงุช ุชูุทุจู ูุญููุงู ููุฑุงู

2. **ุนูุฏ ุงูุนูุฏุฉ ุฃูููุงูู**:
   - Push ุงูุนูููุงุช ุงููุนููุฉ
   - Pull ุงูุนูููุงุช ุงููุงุฆุชุฉ
   - ุฅุนุงุฏุฉ ุงุชุตุงู WebSocket

## ๐จ ูุคุดุฑ ุงูุญุงูุฉ

```
๐ข ุฃุฎุถุฑ ูุชูุฃูุฆ = ูุชุตู ุจุงูู realtime
๐ต ุฃุฒุฑู ุฏูุงุฑ = ุฌุงุฑู ุงููุฒุงููุฉ
๐ข ุฃุฎุถุฑ ุซุงุจุช = ุชูุช ุงููุฒุงููุฉ
๐ด ุฃุญูุฑ = ุบูุฑ ูุชุตู ุฃู ุฎุทุฃ
```

## โก ุงูุฃุฏุงุก

- **WebSocket**: < 100ms ูุชูุตูู ุงูุชุบููุฑุงุช
- **Fallback Polling**: ูู 5 ุซูุงูู ุนูุฏ ูุดู WebSocket
- **Batch Operations**: ุญุชู 25 ุนูููุฉ ูู ูู ุฏูุนุฉ

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

1. **A ูุนุฏู โ B ูุฑู ููุฑุงู**: โ
2. **B ูุนุฏู โ A ูุฑู ููุฑุงู**: โ
3. **A ุฃูููุงูู โ ูุนุฏู โ ุฃูููุงูู โ B ูุฑู**: โ
4. **ุตูุญุงุช ุจุฏูู ุชุนููู ูุงููุงุฆู**: โ

## ๐ ููุงุญุธุงุช ูุงูุฉ

- ุฌููุน ุตูุญุงุช React ุชุณุชุฎุฏู `useLiveQuery` ูุชุชุญุฏุซ ุชููุงุฆูุงู
- ูุง ุญุงุฌุฉ ูุชุบููุฑ ููุทู ุงูุนุฑุถ
- ุงููุธุงู ูุนูู ูุน Electron ูุงููุชุตูุญ ุจููุณ ุงูุณููู
